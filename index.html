<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizontal Prayer Widget</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. THEME ENGINE --- */
        :root {
            --bg-card: #581c33; /* Default Dark Red/Pink base */
            --border-card: #7a2646;
            --text-primary: #ffffff;
            --text-secondary: #ffccd5;
            --highlight-bg: #8f2d52;
            --shadow: rgba(0,0,0,0.4);
            --font-ar: 'Cairo', sans-serif;
            --font-en: 'Roboto', sans-serif;
        }

        /* THEMES */
        [data-theme="purple"] { --bg-card: #2e1a47; --border-card: #4a2b70; --highlight-bg: #5e3691; --text-secondary: #dcd0ff; }
        [data-theme="blue"] { --bg-card: #1a2e47; --border-card: #2b4a70; --highlight-bg: #365e91; --text-secondary: #d0e1ff; }
        [data-theme="green"] { --bg-card: #1a472e; --border-card: #2b7048; --highlight-bg: #36915e; --text-secondary: #d0ffd6; }
        [data-theme="black"] { --bg-card: #111; --border-card: #333; --highlight-bg: #333; --text-secondary: #ccc; }
        [data-theme="pink"] { --bg-card: #581c33; --border-card: #7a2646; --highlight-bg: #8f2d52; --text-secondary: #ffccd5; }

        /* GLOBAL */
        body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            font-family: var(--font-ar);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* --- LAYOUT CONTAINER --- */
        .widget-container {
            background-color: var(--bg-card);
            border: 1px solid var(--border-card);
            border-radius: 12px;
            width: 98%;
            max-width: 1000px; /* Wide layout */
            box-shadow: 0 4px 15px var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s;
            position: relative;
        }

        /* TOP BAR: Countdown, Date, Mosque Icon */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border-card);
        }

        .info-group {
            text-align: center;
        }

        .countdown-box {
            font-size: 1.4rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .date-box {
            font-size: 0.85rem;
            color: var(--text-secondary);
            direction: ltr; /* Force dates to display nicely */
        }

        .mosque-icon {
            font-size: 3rem;
            opacity: 0.8;
            margin: 0 15px;
        }

        /* MIDDLE BAR: Prayer Times (Horizontal) */
        .prayers-bar {
            display: flex;
            flex-direction: row-reverse; /* RTL for Arabic default */
            justify-content: space-between;
            background-color: rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        /* Ensure LTR for English */
        [dir="ltr"] .prayers-bar {
            flex-direction: row;
        }

        .prayer-item {
            flex: 1;
            padding: 15px 5px;
            text-align: center;
            border-left: 1px solid var(--border-card);
            border-right: 1px solid var(--border-card);
            transition: background 0.3s;
            min-width: 80px;
        }

        .prayer-item.active {
            background-color: var(--highlight-bg);
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .p-name {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .p-time {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            direction: ltr;
        }

        /* BOTTOM BAR: Controls & Location */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: rgba(0,0,0,0.25);
            border-top: 1px solid var(--border-card);
            flex-wrap: wrap;
            gap: 10px;
        }

        .controls-left, .controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* INPUTS & SELECTS */
        select, .lang-btn {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid var(--border-card);
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: inherit;
            cursor: pointer;
            outline: none;
        }
        select option {
            background-color: #333;
        }

        /* ICONS */
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-secondary);
            transition: 0.2s;
        }
        .icon-btn:hover { color: #fff; transform: scale(1.1); }
        .active-sound { color: #4caf50; } /* Green when sound is on */

        /* COLOR MENU */
        .color-popup {
            display: none;
            position: absolute;
            bottom: 50px;
            left: 10px;
            background: #222;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 5px;
            z-index: 100;
        }
        .color-dot {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin: 3px;
            cursor: pointer;
            border: 1px solid #fff;
        }

        /* RESPONSIVE */
        @media (max-width: 600px) {
            .prayers-bar { overflow-x: scroll; }
            .top-bar { flex-direction: column; text-align: center; }
            .mosque-icon { display: none; }
            .controls-bar { flex-direction: column; }
        }
    </style>
</head>
<body>

    <audio id="adhan-audio" src="https://cdn.aladhan.com/audio/adhan/Makkah.mp3" preload="auto"></audio>

    <div class="widget-container">
        
        <!-- TOP: Countdown & Info -->
        <div class="top-bar">
            <div class="info-group">
                <div class="countdown-box" id="countdown-display">--:--:--</div>
                <div class="date-box" id="date-display">Loading Dates...</div>
            </div>
            
            <div class="mosque-icon">ðŸ•Œ</div>

            <div class="info-group">
                <div style="font-size: 1.1rem; font-weight: bold;" id="city-label">...</div>
                <div style="font-size: 0.9rem; opacity: 0.8;" id="clock-display">00:00</div>
            </div>
        </div>

        <!-- MIDDLE: Prayer Times -->
        <div class="prayers-bar" id="prayers-container">
            <!-- Items injected by JS -->
        </div>

        <!-- BOTTOM: Controls -->
        <div class="controls-bar">
            <div class="controls-left">
                <!-- Color Palette -->
                <button class="icon-btn" onclick="toggleColorMenu()">ðŸŽ¨</button>
                <div class="color-popup" id="color-menu">
                    <span class="color-dot" style="background:#581c33" onclick="setTheme('pink')"></span>
                    <span class="color-dot" style="background:#2e1a47" onclick="setTheme('purple')"></span>
                    <span class="color-dot" style="background:#1a2e47" onclick="setTheme('blue')"></span>
                    <span class="color-dot" style="background:#1a472e" onclick="setTheme('green')"></span>
                    <span class="color-dot" style="background:#000" onclick="setTheme('black')"></span>
                </div>

                <!-- Sound Toggle -->
                <button class="icon-btn active-sound" id="sound-btn" onclick="toggleSound()" title="Sound">ðŸ”Š</button>
                
                <!-- Language Toggle -->
                <button class="lang-btn" onclick="toggleLang()" id="lang-btn">EN</button>
            </div>

            <div class="controls-right">
                <!-- Live Location Selectors -->
                <select id="country-select" onchange="updateLocation()">
                    <option value="Algeria">Algeria</option>
                    <option value="Saudi Arabia">Saudi Arabia</option>
                    <option value="Egypt">Egypt</option>
                    <option value="Morocco">Morocco</option>
                    <option value="Tunisia">Tunisia</option>
                    <option value="France">France</option>
                    <option value="US">USA</option>
                    <option value="UK">UK</option>
                </select>

                <!-- City Input (Text for flexibility or Dropdown) -->
                <!-- I will use a list of Algerian cities since that's your focus, but editable -->
                <input type="text" id="city-input" list="dz-cities" value="Ain Oussera" 
                       style="background:rgba(255,255,255,0.1); border:1px solid var(--border-card); color:#fff; padding:5px; border-radius:4px; width:120px;" 
                       onchange="updateLocation()">
                
                <!-- Datalist for Auto-complete -->
                <datalist id="dz-cities">
                    <option value="Ain Oussera">
                    <option value="Djelfa">
                    <option value="Algiers">
                    <option value="Oran">
                    <option value="Constantine">
                    <option value="Annaba">
                    <option value="Setif">
                    <option value="Batna">
                    <option value="Tlemcen">
                    <option value="Ouargla">
                </datalist>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const state = {
            lang: localStorage.getItem('prayerLang') || 'ar',
            theme: localStorage.getItem('prayerTheme') || 'pink',
            sound: true, // Default to ON, user can turn off
            city: "Ain Oussera",
            country: "Algeria",
            timings: null,
            nextPrayerIndex: -1
        };

        const translations = {
            ar: {
                fajr: "Ø§Ù„ÙØ¬Ø±", sunrise: "Ø§Ù„Ø´Ø±ÙˆÙ‚", dhuhr: "Ø§Ù„Ø¸Ù‡Ø±", asr: "Ø§Ù„Ø¹ØµØ±", maghrib: "Ø§Ù„Ù…ØºØ±Ø¨", isha: "Ø§Ù„Ø¹Ø´Ø§Ø¡",
                next: "Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰", loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", langBtn: "EN"
            },
            en: {
                fajr: "Fajr", sunrise: "Sunrise", dhuhr: "Dhuhr", asr: "Asr", maghrib: "Maghrib", isha: "Isha",
                next: "Time to", loading: "Loading...", langBtn: "Ø¹Ø±Ø¨ÙŠ"
            }
        };

        const prayerNames = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
        let audioPlayer = document.getElementById('adhan-audio');

        // --- INITIALIZATION ---
        init();

        function init() {
            // Unlock Audio Hack (Browsers require interaction)
            document.body.addEventListener('click', () => {
                if(state.sound && audioPlayer.paused) {
                    audioPlayer.play().then(() => {
                        audioPlayer.pause(); 
                        audioPlayer.currentTime = 0;
                    }).catch(()=>{});
                }
            }, { once: true });

            setTheme(state.theme);
            setLang(state.lang);
            
            // Get URL params if they exist, otherwise use defaults
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('city')) state.city = urlParams.get('city');
            if(urlParams.get('country')) state.country = urlParams.get('country');

            // Update Input Fields
            document.getElementById('city-input').value = state.city;
            document.getElementById('country-select').value = state.country;

            fetchPrayers();
            
            // Timer Loop
            setInterval(() => {
                updateClock();
                if(state.timings) updateCountdown();
            }, 1000);
        }

        // --- FETCH DATA ---
        async function fetchPrayers() {
            const api = `https://api.aladhan.com/v1/timingsByCity?city=${state.city}&country=${state.country}&method=19`;
            try {
                const res = await fetch(api);
                const data = await res.json();
                state.timings = data.data.timings;
                
                // Dates
                const hijri = data.data.date.hijri;
                const greg = data.data.date.gregorian;
                const dateStr = `${greg.date} | ${hijri.day} ${hijri.month.ar} ${hijri.year}`;
                document.getElementById('date-display').innerText = dateStr;

                renderPrayers();
                updateCountdown();
            } catch (e) {
                console.error(e);
            }
        }

        // --- RENDER UI ---
        function renderPrayers() {
            const container = document.getElementById('prayers-container');
            container.innerHTML = '';
            
            const t = translations[state.lang];
            
            prayerNames.forEach(key => {
                const time = state.timings[key].split(' ')[0]; // remove (CET) etc
                const name = t[key.toLowerCase()];
                
                const div = document.createElement('div');
                div.className = 'prayer-item';
                div.id = `p-${key}`;
                div.innerHTML = `
                    <span class="p-name">${name}</span>
                    <span class="p-time">${time}</span>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('city-label').innerText = state.city;
        }

        // --- COUNTDOWN & LOGIC ---
        function updateCountdown() {
            const now = new Date();
            const currentMins = now.getHours() * 60 + now.getMinutes();
            const currentSeconds = now.getSeconds();
            
            let nextFound = false;
            let minDiff = 9999;
            let nextPName = "";

            prayerNames.forEach((key, index) => {
                if(key === 'Sunrise') return; // Skip countdown to sunrise usually

                const [h, m] = state.timings[key].split(':').map(Number);
                const pMins = h * 60 + m;
                
                // Highlight current/next
                const el = document.getElementById(`p-${key}`);
                if(el) el.classList.remove('active');

                if (!nextFound && pMins > currentMins) {
                    nextFound = true;
                    state.nextPrayerIndex = index;
                    nextPName = key;
                    if(el) el.classList.add('active');
                    
                    // Calc Diff
                    const diffMins = pMins - currentMins - 1;
                    const diffSecs = 60 - currentSeconds;
                    
                    const hLeft = Math.floor(diffMins / 60);
                    const mLeft = diffMins % 60;
                    
                    const t = translations[state.lang];
                    const label = t[nextPName.toLowerCase()];
                    
                    document.getElementById('countdown-display').innerText = 
                        `${t.next} ${label}: ${hLeft}:${mLeft < 10 ? '0'+mLeft : mLeft}:${diffSecs < 10 ? '0'+diffSecs : diffSecs}`;

                    // CHECK FOR SOUND
                    if(state.sound && hLeft === 0 && mLeft === 0 && diffSecs === 1) {
                        playSound();
                    }
                }
            });

            // If no prayer found (after Isha), next is Fajr tomorrow
            if(!nextFound) {
                const fajrTime = state.timings['Fajr'];
                const t = translations[state.lang];
                document.getElementById('countdown-display').innerText = `${t.next} ${t.fajr}`;
                const el = document.getElementById('p-Fajr');
                if(el) el.classList.add('active');
            }
        }

        function playSound() {
            audioPlayer.currentTime = 0;
            audioPlayer.play().catch(e => console.log("Audio blocked by browser"));
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock-display').innerText = 
                now.toLocaleTimeString(state.lang === 'ar' ? 'ar-DZ' : 'en-US', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        }

        // --- CONTROLS FUNCTIONS ---
        function toggleLang() {
            setLang(state.lang === 'ar' ? 'en' : 'ar');
            renderPrayers(); // Re-render names
        }

        function setLang(l) {
            state.lang = l;
            localStorage.setItem('prayerLang', l);
            document.documentElement.lang = l;
            document.documentElement.dir = l === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('lang-btn').innerText = translations[l].langBtn;
            
            // Adjust CSS flex direction via simple reload or just render
            // renderPrayers handles text, CSS handles layout based on [dir]
        }

        function toggleSound() {
            state.sound = !state.sound;
            const btn = document.getElementById('sound-btn');
            if(state.sound) {
                btn.innerText = "ðŸ”Š";
                btn.classList.add('active-sound');
                btn.style.opacity = "1";
            } else {
                btn.innerText = "ðŸ”‡";
                btn.classList.remove('active-sound');
                btn.style.opacity = "0.6";
                audioPlayer.pause();
            }
        }

        function toggleColorMenu() {
            const m = document.getElementById('color-menu');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }

        function setTheme(theme) {
            state.theme = theme;
            localStorage.setItem('prayerTheme', theme);
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('color-menu').style.display = 'none';
        }

        function updateLocation() {
            const country = document.getElementById('country-select').value;
            const city = document.getElementById('city-input').value;
            
            if(city && country) {
                state.city = city;
                state.country = country;
                document.getElementById('date-display').innerText = translations[state.lang].loading;
                fetchPrayers();
            }
        }
    </script>
</body>
</html>
