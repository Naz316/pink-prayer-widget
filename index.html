<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precise Prayer Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. THEME ENGINE --- */
        :root {
            --bg-card: #2b1d20;
            --border-card: #4f2a32;
            --header-bg: rgba(0,0,0,0.2);
            --text-primary: #ffffff;
            --text-secondary: #ffccd5;
            --highlight-bg: #782a3b;
            --input-bg: rgba(255,255,255,0.1);
            --font-main: 'Roboto', sans-serif;
            --direction: ltr;
        }

        /* THEMES (All 12 Colors Restored) */
        [data-theme="pink"] { --bg-card: #581c33; --border-card: #7a2646; --highlight-bg: #8f2d52; --text-secondary: #ffccd5; }
        [data-theme="purple"] { --bg-card: #2e1a47; --border-card: #4a2b70; --highlight-bg: #5e3691; --text-secondary: #dcd0ff; }
        [data-theme="red"] { --bg-card: #3d0e0e; --border-card: #5e2222; --highlight-bg: #7a1f1f; --text-secondary: #ffcccc; }
        [data-theme="orange"] { --bg-card: #42210b; --border-card: #663614; --highlight-bg: #8f4718; --text-secondary: #ffdec7; }
        [data-theme="yellow"] { --bg-card: #3d360e; --border-card: #615619; --highlight-bg: #85751f; --text-secondary: #fff8cc; }
        [data-theme="green"] { --bg-card: #13381e; --border-card: #225e34; --highlight-bg: #2d7a44; --text-secondary: #ccffda; }
        [data-theme="cyan"] { --bg-card: #0e333d; --border-card: #1d5666; --highlight-bg: #24768a; --text-secondary: #ccf7ff; }
        [data-theme="blue"] { --bg-card: #111e3d; --border-card: #213666; --highlight-bg: #2b498a; --text-secondary: #ccd9ff; }
        [data-theme="brown"] { --bg-card: #3d2b1e; --border-card: #5e4430; --highlight-bg: #7a583e; --text-secondary: #ffeacc; }
        [data-theme="grey"] { --bg-card: #262626; --border-card: #404040; --highlight-bg: #595959; --text-secondary: #e0e0e0; }
        [data-theme="black"] { --bg-card: #000000; --border-card: #333333; --highlight-bg: #333333; --text-secondary: #cccccc; }
        [data-theme="white"] { --bg-card: #ffffff; --border-card: #e0e0e0; --highlight-bg: #e0e0e0; --text-secondary: #666666; --text-primary: #222; --input-bg: rgba(0,0,0,0.05); }

        /* ARABIC OVERRIDES */
        [lang="ar"] {
            --font-main: 'Cairo', sans-serif;
            --direction: rtl;
        }

        /* --- LAYOUT --- */
        body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            font-family: var(--font-main);
            direction: var(--direction);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Aligns to top for better notion fit */
            min-height: 100vh;
            color: var(--text-primary);
            overflow: hidden; 
        }

        .widget-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-card);
            border-radius: 12px;
            width: 100%; /* Stretch to fit Notion column */
            max-width: 600px; /* Limit max width so it doesn't look weird on big screens */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s;
        }

        /* TOP SECTION */
        .header-row {
            display: flex;
            justify-content: space-between; /* Sides and Center */
            align-items: center;
            padding: 15px 15px 5px 15px;
            background-color: var(--header-bg);
            position: relative;
        }

        .header-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 80px;
        }

        /* Left: Countdown (Aligned Start) */
        .align-start {
            align-items: flex-start;
            text-align: left;
        }
        [lang="ar"] .align-start { align-items: flex-start; text-align: right; }

        /* Right: Location/Clock (Aligned End) */
        .align-end {
            align-items: flex-end;
            text-align: right;
        }
        [lang="ar"] .align-end { align-items: flex-end; text-align: left; }

        /* Center: Mosque */
        .align-center {
            align-items: center;
            text-align: center;
        }

        .label-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .main-text {
            font-size: 1.1rem;
            font-weight: bold;
        }
        .mosque-icon {
            font-size: 2.5rem;
            opacity: 0.9;
        }

        /* DATE ROW */
        .date-row {
            text-align: center;
            padding: 5px 10px 10px 10px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-card);
        }
        .date-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* PRAYER BAR (Scrollable) */
        .prayer-bar {
            display: flex;
            overflow-x: auto;
            background-color: rgba(0,0,0,0.1);
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .prayer-bar::-webkit-scrollbar { display: none; } /* Hide Chrome */

        .prayer-item {
            flex: 1;
            min-width: 60px;
            padding: 10px 5px;
            text-align: center;
            border-right: 1px solid var(--border-card);
            position: relative;
        }
        [lang="ar"] .prayer-item { border-right: none; border-left: 1px solid var(--border-card); }
        
        .prayer-item.active {
            background-color: var(--highlight-bg);
            font-weight: bold;
        }
        .p-name { font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 2px; }
        .p-time { font-size: 0.95rem; font-weight: bold; display: block; direction: ltr; }

        /* CONTROLS (Bottom) */
        .controls-row {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-top: 1px solid var(--border-card);
        }

        /* Progress Bar style */
        .progress-container {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--text-secondary);
            width: 0%;
            transition: width 1s linear;
        }

        .buttons-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tools {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-secondary);
            transition: 0.2s;
            padding: 0;
        }
        .icon-btn:hover { color: var(--text-primary); transform: scale(1.1); }
        .lang-btn {
            background: var(--input-bg);
            border: 1px solid var(--border-card);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            font-family: inherit;
        }

        /* Equal Input Boxes */
        .inputs-row {
            display: flex;
            gap: 8px;
            width: 100%;
        }
        .input-box {
            flex: 1; /* Takes exactly 50% each */
            background: var(--input-bg);
            border: 1px solid var(--border-card);
            color: var(--text-primary);
            padding: 6px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.85rem;
            outline: none;
            width: 100%; /* Ensure it fills the flex space */
            box-sizing: border-box; /* Includes padding in width */
        }
        .input-box option { background: #333; color: #fff; }

        /* COLOR POPUP */
        .color-popup {
            display: none;
            position: absolute;
            bottom: 45px;
            left: 10px;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 5px;
            z-index: 50;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            width: 100px;
        }
        [lang="ar"] .color-popup { left: auto; right: 10px; }
        
        .color-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3);
        }

    </style>
</head>
<body>

    <audio id="adhan-audio" src="https://cdn.aladhan.com/audio/adhan/Makkah.mp3" preload="auto"></audio>

    <div class="widget-card">
        
        <!-- HEADER: Countdown, Mosque, Location -->
        <div class="header-row">
            <!-- Left: Countdown -->
            <div class="header-item align-start">
                <span class="label-text" id="lbl-next">Next Prayer</span>
                <span class="main-text" id="countdown">--:--:--</span>
            </div>

            <!-- Center: Mosque -->
            <div class="header-item align-center">
                <div class="mosque-icon">ðŸ•Œ</div>
            </div>

            <!-- Right: Location & Clock -->
            <div class="header-item align-end">
                <span class="label-text" id="city-display">...</span>
                <span class="main-text" id="clock">00:00</span>
            </div>
        </div>

        <!-- DATE DISPLAY -->
        <div class="date-row">
            <div class="date-text" id="date-display">Loading dates...</div>
        </div>

        <!-- PRAYER TIMES SCROLL -->
        <div class="prayer-bar" id="prayers-container">
            <!-- JS inserts here -->
        </div>

        <!-- CONTROLS -->
        <div class="controls-row">
            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-fill" id="time-bar"></div>
            </div>

            <div class="buttons-row">
                <div class="tools">
                    <button class="lang-btn" onclick="toggleLang()" id="btn-lang">EN</button>
                    <button class="icon-btn" onclick="toggleSound()" id="btn-sound">ðŸ”Š</button>
                    <button class="icon-btn" onclick="toggleColors()">ðŸŽ¨</button>
                    
                    <!-- Color Menu -->
                    <div class="color-popup" id="color-menu">
                        <div class="color-dot" style="background:#581c33" onclick="setTheme('pink')"></div>
                        <div class="color-dot" style="background:#2e1a47" onclick="setTheme('purple')"></div>
                        <div class="color-dot" style="background:#3d0e0e" onclick="setTheme('red')"></div>
                        <div class="color-dot" style="background:#42210b" onclick="setTheme('orange')"></div>
                        <div class="color-dot" style="background:#85751f" onclick="setTheme('yellow')"></div>
                        <div class="color-dot" style="background:#13381e" onclick="setTheme('green')"></div>
                        <div class="color-dot" style="background:#0e333d" onclick="setTheme('cyan')"></div>
                        <div class="color-dot" style="background:#111e3d" onclick="setTheme('blue')"></div>
                        <div class="color-dot" style="background:#3d2b1e" onclick="setTheme('brown')"></div>
                        <div class="color-dot" style="background:#595959" onclick="setTheme('grey')"></div>
                        <div class="color-dot" style="background:#000" onclick="setTheme('black')"></div>
                        <div class="color-dot" style="background:#fff" onclick="setTheme('white')"></div>
                    </div>
                </div>
            </div>

            <!-- EQUAL INPUTS ROW -->
            <div class="inputs-row">
                <!-- City Input -->
                <input type="text" id="input-city" class="input-box" value="Ain Oussera" onchange="updateLoc()">
                
                <!-- Country Select -->
                <select id="input-country" class="input-box" onchange="updateLoc()">
                    <option value="Algeria">Algeria</option>
                    <option value="Saudi Arabia">Saudi Arabia</option>
                    <option value="Egypt">Egypt</option>
                    <option value="Morocco">Morocco</option>
                    <option value="Tunisia">Tunisia</option>
                    <option value="France">France</option>
                    <option value="US">USA</option>
                    <option value="UK">UK</option>
                    <option value="Turkey">Turkey</option>
                    <option value="Indonesia">Indonesia</option>
                    <option value="Malaysia">Malaysia</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const state = {
            lang: localStorage.getItem('p_lang') || 'en',
            theme: localStorage.getItem('p_theme') || 'pink',
            sound: true,
            city: "Ain Oussera",
            country: "Algeria",
            timings: null,
            hijri: null,
            greg: null
        };

        const TEXT = {
            en: {
                fajr: "Fajr", sunrise: "Sunrise", dhuhr: "Dhuhr", asr: "Asr", maghrib: "Maghrib", isha: "Isha",
                next: "Next Prayer", loading: "Loading...", btn: "Ø¹Ø±Ø¨ÙŠ"
            },
            ar: {
                fajr: "Ø§Ù„ÙØ¬Ø±", sunrise: "Ø§Ù„Ø´Ø±ÙˆÙ‚", dhuhr: "Ø§Ù„Ø¸Ù‡Ø±", asr: "Ø§Ù„Ø¹ØµØ±", maghrib: "Ø§Ù„Ù…ØºØ±Ø¨", isha: "Ø§Ù„Ø¹Ø´Ø§Ø¡",
                next: "Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", btn: "EN"
            }
        };

        const audio = document.getElementById('adhan-audio');

        // --- INIT ---
        window.onload = () => {
            // Unlock Audio
            document.body.addEventListener('click', () => {
                if(state.sound && audio.paused) {
                    audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(()=>{});
                }
            }, { once: true });

            // Restore State
            applyTheme(state.theme);
            applyLang(state.lang);
            
            // URL Params Override
            const params = new URLSearchParams(window.location.search);
            if(params.get('city')) state.city = params.get('city');
            if(params.get('country')) state.country = params.get('country');
            if(params.get('theme')) applyTheme(params.get('theme'));

            // Set Inputs
            document.getElementById('input-city').value = state.city;
            document.getElementById('input-country').value = state.country;

            fetchData();
            setInterval(tick, 1000);
        };

        // --- CORE LOGIC ---
        async function fetchData() {
            try {
                const url = `https://api.aladhan.com/v1/timingsByCity?city=${state.city}&country=${state.country}&method=19`;
                const res = await fetch(url);
                const data = await res.json();
                
                state.timings = data.data.timings;
                state.hijri = data.data.date.hijri;
                state.greg = data.data.date.gregorian;

                renderUI();
            } catch (e) { console.error(e); }
        }

        function tick() {
            const now = new Date();
            
            // Clock
            const timeOpts = { hour: '2-digit', minute:'2-digit', hour12: false };
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB', timeOpts);

            if(state.timings) updateCountdown(now);
        }

        function updateCountdown(now) {
            const prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            const curMins = now.getHours() * 60 + now.getMinutes();
            const curSecs = now.getSeconds();

            let nextP = null;
            let nextName = "";
            let nextIndex = -1;

            // Find Next Prayer
            for(let i=0; i<prayers.length; i++) {
                const [h, m] = state.timings[prayers[i]].split(':').map(Number);
                const pMins = h * 60 + m;
                if(pMins > curMins) {
                    nextP = pMins;
                    nextName = prayers[i];
                    nextIndex = i;
                    break;
                }
            }

            // If none found, next is Fajr tomorrow
            if(!nextP) {
                const [h, m] = state.timings['Fajr'].split(':').map(Number);
                nextP = (h * 60 + m) + (24 * 60); // Add 24 hours
                nextName = 'Fajr';
                nextIndex = 0;
            }

            // Highlight Active
            document.querySelectorAll('.prayer-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`p-${nextName}`);
            if(activeEl) activeEl.classList.add('active');

            // Countdown Math
            const diffMins = nextP - curMins - 1;
            const diffSecs = 60 - curSecs;
            const hLeft = Math.floor(diffMins / 60);
            const mLeft = diffMins % 60;

            const str = `-${hLeft}:${mLeft<10?'0'+mLeft:mLeft}:${diffSecs<10?'0'+diffSecs:diffSecs}`;
            document.getElementById('countdown').innerText = str;
            
            // Labels
            const dict = TEXT[state.lang];
            const pNameTrans = dict[nextName.toLowerCase()];
            
            if(state.lang === 'ar') {
                document.getElementById('lbl-next').innerText = `${dict.next}: ${pNameTrans}`;
            } else {
                document.getElementById('lbl-next').innerText = `${dict.next}: ${pNameTrans}`;
            }

            // Play Sound
            if(state.sound && hLeft===0 && mLeft===0 && diffSecs===1 && nextName !== 'Sunrise') {
                audio.play();
            }

            // Progress Bar (Visual flair)
            const prevIndex = nextIndex === 0 ? 5 : nextIndex - 1;
            const prevName = prevIndex === 5 && nextIndex === 0 ? 'Isha' : prayers[prevIndex];
            // Simple visual fill logic could go here, simplified for space
        }

        // --- PRECISE DATE FORMATTING ---
        function formatDate() {
            if(!state.greg || !state.hijri) return;
            
            const g = state.greg; 
            const h = state.hijri;
            const el = document.getElementById('date-display');

            if (state.lang === 'en') {
                // English: "12th Jumada Al-Akhirah, 1447h" <br> "Wednesday, Dec 03, 2025"
                const suffix = getOrdinal(h.day);
                const hijriStr = `${h.day}${suffix} ${h.month.en}, ${h.year}h`;
                const gregStr = `${g.weekday.en}, ${g.month.en.substr(0,3)} ${g.day}, ${g.year}`;
                el.innerHTML = `<span style="opacity:0.8">${hijriStr}</span><br><span style="font-weight:bold">${gregStr}</span>`;
            } else {
                // Arabic: Combined specific format
                // Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ØŒ 3 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025Ù… | 12 Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠ 1447Ù‡Ù€
                const gregStr = `${g.weekday.ar}ØŒ ${g.day} ${g.month.ar} ${g.year}Ù…`;
                const hijriStr = `${h.day} ${h.month.ar} ${h.year}Ù‡Ù€`;
                el.innerHTML = `${gregStr} | ${hijriStr}`;
            }
        }

        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        // --- RENDER UI ---
        function renderUI() {
            // Render Prayers
            const container = document.getElementById('prayers-container');
            container.innerHTML = '';
            const dict = TEXT[state.lang];
            const list = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

            list.forEach(k => {
                const time = state.timings[k].split(' ')[0];
                const div = document.createElement('div');
                div.className = 'prayer-item';
                div.id = `p-${k}`;
                div.innerHTML = `<span class="p-name">${dict[k.toLowerCase()]}</span><span class="p-time">${time}</span>`;
                container.appendChild(div);
            });

            document.getElementById('city-display').innerText = state.city;
            formatDate();
        }

        // --- ACTIONS ---
        function toggleLang() {
            applyLang(state.lang === 'en' ? 'ar' : 'en');
            renderUI();
        }

        function applyLang(l) {
            state.lang = l;
            localStorage.setItem('p_lang', l);
            document.documentElement.lang = l;
            document.getElementById('btn-lang').innerText = TEXT[l].btn;
            
            // RTL/LTR logic
            if(l === 'ar') {
                document.documentElement.style.setProperty('--direction', 'rtl');
                document.getElementById('input-city').placeholder = "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©";
            } else {
                document.documentElement.style.setProperty('--direction', 'ltr');
                document.getElementById('input-city').placeholder = "City";
            }
        }

        function toggleSound() {
            state.sound = !state.sound;
            const btn = document.getElementById('btn-sound');
            btn.innerText = state.sound ? "ðŸ”Š" : "ðŸ”‡";
            btn.style.opacity = state.sound ? "1" : "0.5";
        }

        function toggleColors() {
            const m = document.getElementById('color-menu');
            m.style.display = m.style.display === 'grid' ? 'none' : 'grid';
        }

        function applyTheme(t) {
            state.theme = t;
            localStorage.setItem('p_theme', t);
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('color-menu').style.display = 'none';
        }
        function setTheme(t) { applyTheme(t); }

        function updateLoc() {
            state.city = document.getElementById('input-city').value;
            state.country = document.getElementById('input-country').value;
            document.getElementById('date-display').innerText = TEXT[state.lang].loading;
            fetchData();
        }
    </script>
</body>
</html>
