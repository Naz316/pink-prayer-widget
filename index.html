<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precise Prayer Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. CSS RESET & VARIABLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-card: #2b1d20;
            --border-card: #4f2a32;
            --header-bg: rgba(0,0,0,0.2);
            --text-primary: #ffffff;
            --text-secondary: #ffccd5;
            --text-accent: #ff8fa3; 
            --highlight-bg: #782a3b;
            --input-bg: rgba(255,255,255,0.1);
            --font-main: 'Roboto', sans-serif;
        }

        /* THEMES */
        [data-theme="pink"] { --bg-card: #581c33; --border-card: #7a2646; --highlight-bg: #8f2d52; --text-secondary: #ffccd5; --text-accent: #ff9eb5; }
        [data-theme="purple"] { --bg-card: #2e1a47; --border-card: #4a2b70; --highlight-bg: #5e3691; --text-secondary: #dcd0ff; --text-accent: #c4a6ff; }
        [data-theme="red"] { --bg-card: #3d0e0e; --border-card: #5e2222; --highlight-bg: #7a1f1f; --text-secondary: #ffcccc; --text-accent: #ff8888; }
        [data-theme="orange"] { --bg-card: #42210b; --border-card: #663614; --highlight-bg: #8f4718; --text-secondary: #ffdec7; --text-accent: #ffb380; }
        [data-theme="yellow"] { --bg-card: #3d360e; --border-card: #615619; --highlight-bg: #85751f; --text-secondary: #fff8cc; --text-accent: #ffe666; }
        [data-theme="green"] { --bg-card: #13381e; --border-card: #225e34; --highlight-bg: #2d7a44; --text-secondary: #ccffda; --text-accent: #88ffaa; }
        [data-theme="cyan"] { --bg-card: #0e333d; --border-card: #1d5666; --highlight-bg: #24768a; --text-secondary: #ccf7ff; --text-accent: #66eeff; }
        [data-theme="blue"] { --bg-card: #111e3d; --border-card: #213666; --highlight-bg: #2b498a; --text-secondary: #ccd9ff; --text-accent: #88aaff; }
        [data-theme="brown"] { --bg-card: #3d2b1e; --border-card: #5e4430; --highlight-bg: #7a583e; --text-secondary: #ffeacc; --text-accent: #ffcc99; }
        [data-theme="grey"] { --bg-card: #262626; --border-card: #404040; --highlight-bg: #595959; --text-secondary: #e0e0e0; --text-accent: #aaaaaa; }
        [data-theme="black"] { --bg-card: #000000; --border-card: #333333; --highlight-bg: #333333; --text-secondary: #cccccc; --text-accent: #999999; }
        [data-theme="white"] { --bg-card: #ffffff; --border-card: #e0e0e0; --highlight-bg: #e0e0e0; --text-secondary: #666666; --text-primary: #222; --text-accent: #333; --input-bg: rgba(0,0,0,0.05); }

        [lang="ar"] { 
            --font-main: 'Cairo', sans-serif; 
        }

        /* --- LAYOUT --- */
        body {
            background-color: transparent;
            font-family: var(--font-main);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--text-primary);
            overflow: hidden;
            user-select: none;
        }

        .widget-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-card);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            min-height: 340px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: visible;
            transition: background 0.3s;
            position: relative;
        }

        /* HEADER ROW */
        .header-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--header-bg);
            direction: ltr; 
            height: 90px;
            overflow: hidden;
        }

        .header-item { display: flex; flex-direction: column; justify-content: center; }
        .align-start { align-items: flex-start; text-align: left; }
        .align-end { align-items: flex-end; text-align: right; }
        .align-center { align-items: center; text-align: center; }

        .label-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 14px; 
            white-space: nowrap;
        }
        
        .main-text { font-size: 1.1rem; font-weight: bold; line-height: 1.2; }
        [lang="ar"] .main-text { line-height: 1.1; padding-top: 2px; }

        .mosque-icon { font-size: 2.5rem; opacity: 0.9; margin: 0 10px; line-height: 1; }

        /* --- DATE ROW --- */
        .date-row {
            text-align: center;
            padding: 12px 10px; 
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-card);
            height: auto; 
            min-height: 85px; 
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
        }
        
        .date-hijri {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-accent); 
            margin-bottom: 8px; 
            line-height: 1.2;
            display: block;
        }

        .date-greg {
            font-size: 0.85rem;
            color: var(--text-secondary); 
            font-weight: 600;
            line-height: 1.2;
            display: block;
            opacity: 0.9;
            margin-bottom: 5px; 
        }
        
        [lang="ar"] .date-hijri {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            unicode-bidi: embed;
        }
        [lang="ar"] .date-greg {
            direction: rtl;
        }

        /* PRAYER BAR */
        .prayer-bar {
            display: flex;
            overflow-x: auto;
            background-color: rgba(0,0,0,0.1);
            scrollbar-width: none;
            direction: ltr;
            height: 75px; 
        }
        .prayer-bar::-webkit-scrollbar { display: none; }

        .prayer-item {
            flex: 1;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 1px solid var(--border-card);
            gap: 6px;
        }
        .prayer-item:last-child { border-right: none; }
        
        .prayer-item.active { background-color: var(--highlight-bg); font-weight: bold; }
        .p-name { font-size: 0.75rem; color: var(--text-secondary); margin: 0; line-height: 1; }
        .p-time { font-size: 1rem; font-weight: bold; direction: ltr; line-height: 1; }

        /* CONTROLS SECTION */
        .controls-row {
            padding: 12px 20px; 
            display: flex;
            flex-direction: column;
            gap: 12px; 
            border-top: 1px solid var(--border-card);
            direction: ltr;
            flex-grow: 1; 
            justify-content: center;
        }

        .input-group { display: flex; flex-direction: column; flex: 1; }
        
        .input-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 8px; 
            text-align: center;
            display: block;
            line-height: 1;
        }

        .inputs-row { display: flex; gap: 15px; width: 100%; }

        .input-box {
            background: var(--input-bg);
            border: 1px solid var(--border-card);
            color: var(--text-primary);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
            text-align: center;
            width: 100%;
            height: 38px; 
            line-height: 38px; 
            padding: 0; 
            margin: 0;
            cursor: pointer;
        }
        [lang="ar"] .input-box { font-family: 'Cairo', sans-serif; font-size: 0.85rem; font-weight: 600; }
        .input-box option { background: #333; color: #fff; }

        /* BUTTONS */
        .tools {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 25px;
            position: relative;
            height: 35px; 
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.4rem;
            color: var(--text-secondary);
            transition: 0.2s;
            padding: 0;
            line-height: 1;
        }
        .icon-btn:hover { color: var(--text-primary); transform: scale(1.1); }

        .lang-btn {
            background: var(--input-bg);
            border: 1px solid var(--border-card);
            color: var(--text-primary);
            padding: 0;
            width: 50px;
            height: 28px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* COLOR POPUP */
        .color-popup {
            display: none;
            position: absolute;
            bottom: 45px;
            left: 50%;
            transform: translateX(30px);
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            z-index: 200;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.2s;
            position: relative; 
        }
        .color-dot:hover { transform: scale(1.2); border-color: #fff; }

        .color-dot:hover::after {
            content: attr(data-name);
            position: absolute;
            bottom: 140%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #000;
            color: #fff;
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
            border: 1px solid #555;
            font-family: 'Roboto', sans-serif;
            z-index: 300;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        #audio-hint {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

    </style>
</head>
<body>

    <audio id="adhan-audio" src="https://media.blubrry.com/muslim_central_quran/podcasts.qurancentral.com/adhan/makkah.mp3" preload="auto"></audio>
    <div id="audio-hint">Sound enabled</div>

    <div class="widget-card">
        
        <!-- HEADER -->
        <div class="header-row">
            <div class="header-item align-start">
                <span class="label-text" id="lbl-next">Next Prayer</span>
                <span class="main-text" id="countdown">--:--:--</span>
            </div>
            <div class="header-item align-center">
                <div class="mosque-icon">ðŸ•Œ</div>
            </div>
            <div class="header-item align-end">
                <span class="label-text" id="city-display">...</span>
                <span class="main-text" id="clock">00:00</span>
            </div>
        </div>

        <!-- DATE -->
        <div class="date-row">
            <div class="date-text" id="date-display">Loading...</div>
        </div>

        <!-- PRAYER SCROLL -->
        <div class="prayer-bar" id="prayers-container"></div>

        <!-- CONTROLS -->
        <div class="controls-row">
            
            <div class="inputs-row">
                <div class="input-group">
                    <span class="input-label" id="lbl-city">Choose City</span>
                    <!-- CHANGED FROM INPUT TO SELECT -->
                    <select id="input-city" class="input-box" onchange="updateLoc()"></select>
                </div>
                <div class="input-group">
                    <span class="input-label" id="lbl-country">Choose Country</span>
                    <select id="input-country" class="input-box" onchange="changeCountry()">
                        <option value="Algeria">Algeria</option>
                        <option value="Palestine">Palestine</option>
                        <option value="Saudi Arabia">Saudi Arabia</option>
                        <option value="Egypt">Egypt</option>
                        <option value="Morocco">Morocco</option>
                        <option value="Tunisia">Tunisia</option>
                        <option value="France">France</option>
                        <option value="US">USA</option>
                        <option value="UK">UK</option>
                        <option value="Turkey">Turkey</option>
                        <option value="Indonesia">Indonesia</option>
                        <option value="Malaysia">Malaysia</option>
                    </select>
                </div>
            </div>

            <div class="tools">
                <!-- Sound Left -->
                <button class="icon-btn" onclick="toggleSound()" id="btn-sound">ðŸ”Š</button>
                
                <!-- NEW TEST BUTTON -->
                <button class="icon-btn" onclick="testAdhan()" id="btn-test" title="Test Adhan">â–¶</button>

                <!-- Language Center -->
                <button class="lang-btn" onclick="toggleLang()" id="btn-lang">EN</button>
                
                <!-- Color Right -->
                <button class="icon-btn" onclick="toggleColors()">ðŸŽ¨</button>

                <!-- Color Popup -->
                <div class="color-popup" id="color-menu">
                    <div class="color-dot" data-name="Pink" style="background:#581c33" onclick="setTheme('pink')"></div>
                    <div class="color-dot" data-name="Purple" style="background:#2e1a47" onclick="setTheme('purple')"></div>
                    <div class="color-dot" data-name="Red" style="background:#3d0e0e" onclick="setTheme('red')"></div>
                    <div class="color-dot" data-name="Orange" style="background:#42210b" onclick="setTheme('orange')"></div>
                    <div class="color-dot" data-name="Yellow" style="background:#85751f" onclick="setTheme('yellow')"></div>
                    <div class="color-dot" data-name="Green" style="background:#13381e" onclick="setTheme('green')"></div>
                    <div class="color-dot" data-name="Cyan" style="background:#0e333d" onclick="setTheme('cyan')"></div>
                    <div class="color-dot" data-name="Blue" style="background:#111e3d" onclick="setTheme('blue')"></div>
                    <div class="color-dot" data-name="Brown" style="background:#3d2b1e" onclick="setTheme('brown')"></div>
                    <div class="color-dot" data-name="Grey" style="background:#595959" onclick="setTheme('grey')"></div>
                    <div class="color-dot" data-name="Black" style="background:#000" onclick="setTheme('black')"></div>
                    <div class="color-dot" data-name="White" style="background:#fff" onclick="setTheme('white')"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA: CITIES PER COUNTRY (ENGLISH) ---
        const COUNTRY_DATA = {
            "Algeria": ["Ain Oussera", "Algiers"],
            "Saudi Arabia": ["Makkah", "Madinah"],
            "Palestine": ["Gaza", "Jerusalem"],
            "Egypt": ["Cairo"],
            "Morocco": ["Rabat"],
            "Tunisia": ["Tunis"],
            "France": ["Paris"],
            "US": ["Washington"],
            "UK": ["London"],
            "Turkey": ["Ankara"],
            "Indonesia": ["Jakarta"],
            "Malaysia": ["Kuala Lumpur"]
        };

        // --- 2. TRANSLATION DICTIONARY (COUNTRIES) ---
        const DICT_COUNTRIES = {
            "Algeria": "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±",
            "Palestine": "ÙÙ„Ø³Ø·ÙŠÙ†",
            "Saudi Arabia": "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©",
            "Egypt": "Ù…ØµØ±",
            "Morocco": "Ø§Ù„Ù…ØºØ±Ø¨",
            "Tunisia": "ØªÙˆÙ†Ø³",
            "France": "ÙØ±Ù†Ø³Ø§",
            "US": "Ø£Ù…Ø±ÙŠÙƒØ§",
            "UK": "Ø¨Ø±ÙŠØ·Ø§Ù†ÙŠØ§",
            "Turkey": "ØªØ±ÙƒÙŠØ§",
            "Indonesia": "Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ§",
            "Malaysia": "Ù…Ø§Ù„ÙŠØ²ÙŠØ§"
        };
        
        // --- 3. TRANSLATION DICTIONARY (CITIES) ---
        const DICT_CITIES = {
            "Ain Oussera": "Ø¹ÙŠÙ† ÙˆØ³Ø§Ø±Ø©",
            "Algiers": "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©", // DISTINCT NAME
            "Makkah": "Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©",
            "Madinah": "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©",
            "Gaza": "ØºØ²Ø©",
            "Jerusalem": "Ø§Ù„Ù‚Ø¯Ø³",
            "Cairo": "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©",
            "Rabat": "Ø§Ù„Ø±Ø¨Ø§Ø·",
            "Tunis": "ØªÙˆÙ†Ø³ Ø§Ù„Ø¹Ø§ØµÙ…Ø©",
            "Paris": "Ø¨Ø§Ø±ÙŠØ³",
            "Washington": "ÙˆØ§Ø´Ù†Ø·Ù†",
            "London": "Ù„Ù†Ø¯Ù†",
            "Ankara": "Ø£Ù†Ù‚Ø±Ø©",
            "Jakarta": "Ø¬Ø§ÙƒØ±ØªØ§",
            "Kuala Lumpur": "ÙƒÙˆØ§Ù„Ø§Ù„Ù…Ø¨ÙˆØ±"
        };

        // --- STATE ---
        const state = {
            lang: localStorage.getItem('p_lang') || 'en',
            theme: localStorage.getItem('p_theme') || 'pink',
            sound: true,
            city: "Ain Oussera",
            country: "Algeria",
            timings: null,
            hijri: null,
            timezone: null, 
            audioReady: false,
            lastPlayedPrayer: ""
        };

        const TEXT = {
            en: {
                fajr: "Fajr", sunrise: "Sunrise", dhuhr: "Dhuhr", asr: "Asr", maghrib: "Maghrib", isha: "Isha",
                next: "Next Prayer", loading: "Loading...", btn: "Ø¹Ø±Ø¨ÙŠ",
                selCity: "Choose City", selCountry: "Choose Country"
            },
            ar: {
                fajr: "Ø§Ù„ÙØ¬Ø±", sunrise: "Ø§Ù„Ø´Ø±ÙˆÙ‚", dhuhr: "Ø§Ù„Ø¸Ù‡Ø±", asr: "Ø§Ù„Ø¹ØµØ±", maghrib: "Ø§Ù„Ù…ØºØ±Ø¨", isha: "Ø§Ù„Ø¹Ø´Ø§Ø¡",
                next: "Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", btn: "EN",
                selCity: "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", selCountry: "Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©"
            }
        };

        const audio = document.getElementById('adhan-audio');
        
        // Reset Test Button when audio ends naturally
        audio.addEventListener('ended', () => {
            document.getElementById('btn-test').innerText = "â–¶";
        });

        // --- INIT ---
        window.onload = () => {
            document.addEventListener('click', enableAudio, { once: true });
            document.addEventListener('touchstart', enableAudio, { once: true });

            applyTheme(state.theme);
            
            const params = new URLSearchParams(window.location.search);
            if(params.get('country')) state.country = params.get('country');
            if(params.get('city')) state.city = params.get('city');

            populateCities(state.country);
            document.getElementById('input-city').value = state.city;
            document.getElementById('input-country').value = state.country;

            applyLang(state.lang); 
            
            fetchData();
            setInterval(tick, 1000);
        };

        // --- LOGIC FOR DROPDOWNS ---
        function changeCountry() {
            const countrySelect = document.getElementById('input-country');
            const val = countrySelect.value; 
            const engCountry = getKeyByValue(DICT_COUNTRIES, val) || val;
            
            state.country = engCountry;
            populateCities(state.country);
            
            const citySelect = document.getElementById('input-city');
            state.city = citySelect.options[0].value;
            
            updateLoc();
        }

        function populateCities(country) {
            const citySelect = document.getElementById('input-city');
            citySelect.innerHTML = ""; 

            const cities = COUNTRY_DATA[country] || ["Capital"];
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.text = city; 
                citySelect.appendChild(opt);
            });
            
            if(state.lang === 'ar') updateInputTexts('ar');
        }

        function getKeyByValue(object, value) {
            return Object.keys(object).find(key => object[key] === value);
        }

        // --- API & LOGIC ---
        async function fetchData() {
            try {
                let queryCity = state.city;
                let queryCountry = state.country;

                const englishCity = getKeyByValue(DICT_CITIES, queryCity) || queryCity;
                const englishCountry = getKeyByValue(DICT_COUNTRIES, queryCountry) || queryCountry;

                const url = `https://api.aladhan.com/v1/timingsByCity?city=${englishCity}&country=${englishCountry}&method=19`;
                const res = await fetch(url);
                const data = await res.json();
                
                state.timings = data.data.timings;
                state.hijri = data.data.date.hijri;
                state.timezone = data.data.meta.timezone; 
                
                renderPrayerTimes();
                renderDate();
                tick();
            } catch (e) { 
                console.error("API Error", e);
                document.getElementById('date-display').innerText = "Error Loading Data";
            }
        }

        function getCurrentTimeInZone() {
            const now = new Date();
            if (!state.timezone) {
                return { h: now.getHours(), m: now.getMinutes(), s: now.getSeconds() };
            }
            const formatter = new Intl.DateTimeFormat('en-GB', {
                timeZone: state.timezone,
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                hour12: false
            });
            const parts = formatter.formatToParts(now);
            const h = parseInt(parts.find(p => p.type === 'hour').value);
            const m = parseInt(parts.find(p => p.type === 'minute').value);
            const s = parseInt(parts.find(p => p.type === 'second').value);
            return { h, m, s };
        }

        function tick() {
            const time = getCurrentTimeInZone();
            const clockEl = document.getElementById('clock');
            clockEl.innerText = `${time.h.toString().padStart(2,'0')}:${time.m.toString().padStart(2,'0')}`;

            if(state.timings) updateCountdown(time);
        }

        function updateCountdown(time) {
            const prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            const curMins = time.h * 60 + time.m;
            const curSecs = time.s;

            let nextP = null;
            let nextName = "";

            for(let i=0; i<prayers.length; i++) {
                const [h, m] = state.timings[prayers[i]].split(':').map(Number);
                const pMins = h * 60 + m;
                if(pMins > curMins) {
                    nextP = pMins;
                    nextName = prayers[i];
                    break;
                }
            }

            if(!nextP) {
                const [h, m] = state.timings['Fajr'].split(':').map(Number);
                nextP = (h * 60 + m) + (24 * 60);
                nextName = 'Fajr';
            }

            document.querySelectorAll('.prayer-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`p-${nextName}`);
            if(activeEl) activeEl.classList.add('active');

            // --- SECONDS FIX LOGIC ---
            const nextTotalSeconds = nextP * 60;
            const currentTotalSeconds = (curMins * 60) + curSecs;
            let diffInSeconds = nextTotalSeconds - currentTotalSeconds;
            
            const hLeft = Math.floor(diffInSeconds / 3600);
            diffInSeconds %= 3600;
            const mLeft = Math.floor(diffInSeconds / 60);
            const sLeft = diffInSeconds % 60; // Guarantees 0-59 range

            const str = `-${hLeft}:${mLeft<10?'0'+mLeft:mLeft}:${sLeft<10?'0'+sLeft:sLeft}`;
            document.getElementById('countdown').innerText = str;
            
            const dict = TEXT[state.lang];
            const pNameTrans = dict[nextName.toLowerCase()];
            document.getElementById('lbl-next').innerText = `${dict.next}: ${pNameTrans}`;

            if(state.sound && hLeft === 0 && mLeft === 0 && sLeft <= 2) {
                if(state.lastPlayedPrayer !== nextName && nextName !== 'Sunrise') {
                    if(state.audioReady) {
                        audio.currentTime = 0;
                        audio.play().catch(e => console.error("Play failed:", e));
                        document.getElementById('btn-test').innerText = "â– "; // Update test button to stop icon
                    }
                    state.lastPlayedPrayer = nextName;
                }
            } else if (hLeft > 0 || mLeft > 1) {
                state.lastPlayedPrayer = "";
            }
        }

        function renderDate() {
            if(!state.timings || !state.hijri) return;
            const h = state.hijri;
            const el = document.getElementById('date-display');
            const now = new Date();
            
            if (state.lang === 'en') {
                const suffix = getOrdinal(h.day);
                const hijriStr = `${h.day}${suffix} ${h.month.en}, ${h.year} AH`;
                const gregStr = now.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
                el.innerHTML = `<span class="date-hijri">${hijriStr}</span><span class="date-greg">${gregStr}</span>`;
            } else {
                const hijriStr = `\u200F${h.day} ${h.month.ar} ${h.year} Ù‡Ù€`;
                let gregStr = now.toLocaleDateString('ar-DZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                gregStr += " Ù…"; 
                el.innerHTML = `<span class="date-hijri">${hijriStr}</span><span class="date-greg">${gregStr}</span>`;
            }
        }

        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        function renderPrayerTimes() {
            const container = document.getElementById('prayers-container');
            container.innerHTML = '';
            const dict = TEXT[state.lang];
            const list = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

            list.forEach(k => {
                const time = state.timings[k].split(' ')[0];
                const div = document.createElement('div');
                div.className = 'prayer-item';
                div.id = `p-${k}`;
                div.innerHTML = `<span class="p-name">${dict[k.toLowerCase()]}</span><span class="p-time">${time}</span>`;
                container.appendChild(div);
            });
        }

        function renderStaticText() {
            const dict = TEXT[state.lang];
            document.getElementById('lbl-city').innerText = dict.selCity;
            document.getElementById('lbl-country').innerText = dict.selCountry;
            document.getElementById('btn-lang').innerText = dict.btn;

            let displayCity = state.city;
            if(state.lang === 'ar') {
                 if(DICT_CITIES[displayCity]) displayCity = DICT_CITIES[displayCity];
            } else {
                 const eng = getKeyByValue(DICT_CITIES, displayCity);
                 if(eng) displayCity = eng;
            }
            document.getElementById('city-display').innerText = displayCity;
        }

        function toggleLang() {
            applyLang(state.lang === 'en' ? 'ar' : 'en');
        }

        function applyLang(l) {
            state.lang = l;
            localStorage.setItem('p_lang', l);
            document.documentElement.lang = l;
            
            renderStaticText();
            updateInputTexts(l);

            if(state.timings) {
                renderPrayerTimes();
                renderDate();
            }
        }

        function updateInputTexts(l) {
            const countrySelect = document.getElementById('input-country');
            const cOpts = countrySelect.options;
            for (let i = 0; i < cOpts.length; i++) {
                const engVal = cOpts[i].value; 
                if (l === 'ar' && DICT_COUNTRIES[engVal]) {
                    cOpts[i].text = DICT_COUNTRIES[engVal];
                } else {
                    cOpts[i].text = engVal;
                }
            }

            const citySelect = document.getElementById('input-city');
            const cityOpts = citySelect.options;
            for (let i = 0; i < cityOpts.length; i++) {
                const engVal = cityOpts[i].value;
                if (l === 'ar' && DICT_CITIES[engVal]) {
                    cityOpts[i].text = DICT_CITIES[engVal];
                } else {
                    cityOpts[i].text = engVal;
                }
            }
        }

        function toggleSound() {
            state.sound = !state.sound;
            const btn = document.getElementById('btn-sound');
            btn.innerText = state.sound ? "ðŸ”Š" : "ðŸ”‡";
            btn.style.opacity = state.sound ? "1" : "0.5";
            if(state.sound && !state.audioReady) enableAudio();
        }

        // Added dedicated Test function
        function testAdhan() {
            const btn = document.getElementById('btn-test');
            if (audio.paused) {
                audio.currentTime = 0;
                audio.play().then(() => {
                    btn.innerText = "â– "; // Show stop icon
                }).catch(e => console.error("Test play failed:", e));
            } else {
                audio.pause();
                audio.currentTime = 0;
                btn.innerText = "â–¶"; // Show play icon
            }
        }

        function enableAudio() {
            if(state.sound) {
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    state.audioReady = true;
                    const hint = document.getElementById('audio-hint');
                    hint.style.opacity = '1';
                    setTimeout(() => hint.style.opacity = '0', 2000);
                }).catch(err => console.log("Audio init error:", err));
            }
        }

        function toggleColors() {
            const m = document.getElementById('color-menu');
            m.style.display = m.style.display === 'grid' ? 'none' : 'grid';
        }

        function applyTheme(t) {
            state.theme = t;
            localStorage.setItem('p_theme', t);
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('color-menu').style.display = 'none';
        }
        function setTheme(t) { applyTheme(t); }

        function updateLoc() {
            let cCity = document.getElementById('input-city').value;
            let cCountry = document.getElementById('input-country').value;

            state.city = cCity;
            state.country = cCountry;
            
            document.getElementById('date-display').innerText = TEXT[state.lang].loading;
            
            renderStaticText();
            fetchData();
        }
    </script>
</body>
</html>
