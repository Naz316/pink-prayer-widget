<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precise Prayer Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. CSS RESET & VARIABLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-card: #2b1d20;
            --border-card: #4f2a32;
            --header-bg: rgba(0,0,0,0.2);
            --text-primary: #ffffff;
            --text-secondary: #ffccd5;
            --highlight-bg: #782a3b;
            --input-bg: rgba(255,255,255,0.1);
            --font-main: 'Roboto', sans-serif;
        }

        /* THEMES */
        [data-theme="pink"] { --bg-card: #581c33; --border-card: #7a2646; --highlight-bg: #8f2d52; --text-secondary: #ffccd5; }
        [data-theme="purple"] { --bg-card: #2e1a47; --border-card: #4a2b70; --highlight-bg: #5e3691; --text-secondary: #dcd0ff; }
        [data-theme="red"] { --bg-card: #3d0e0e; --border-card: #5e2222; --highlight-bg: #7a1f1f; --text-secondary: #ffcccc; }
        [data-theme="orange"] { --bg-card: #42210b; --border-card: #663614; --highlight-bg: #8f4718; --text-secondary: #ffdec7; }
        [data-theme="yellow"] { --bg-card: #3d360e; --border-card: #615619; --highlight-bg: #85751f; --text-secondary: #fff8cc; }
        [data-theme="green"] { --bg-card: #13381e; --border-card: #225e34; --highlight-bg: #2d7a44; --text-secondary: #ccffda; }
        [data-theme="cyan"] { --bg-card: #0e333d; --border-card: #1d5666; --highlight-bg: #24768a; --text-secondary: #ccf7ff; }
        [data-theme="blue"] { --bg-card: #111e3d; --border-card: #213666; --highlight-bg: #2b498a; --text-secondary: #ccd9ff; }
        [data-theme="brown"] { --bg-card: #3d2b1e; --border-card: #5e4430; --highlight-bg: #7a583e; --text-secondary: #ffeacc; }
        [data-theme="grey"] { --bg-card: #262626; --border-card: #404040; --highlight-bg: #595959; --text-secondary: #e0e0e0; }
        [data-theme="black"] { --bg-card: #000000; --border-card: #333333; --highlight-bg: #333333; --text-secondary: #cccccc; }
        [data-theme="white"] { --bg-card: #ffffff; --border-card: #e0e0e0; --highlight-bg: #e0e0e0; --text-secondary: #666666; --text-primary: #222; --input-bg: rgba(0,0,0,0.05); }

        [lang="ar"] { --font-main: 'Cairo', sans-serif; }

        /* --- LAYOUT --- */
        body {
            background-color: transparent;
            font-family: var(--font-main);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--text-primary);
            overflow: hidden;
            user-select: none; /* Prevent selection */
        }

        .widget-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-card);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            min-height: 340px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: visible;
            transition: background 0.3s;
            position: relative;
        }

        /* HEADER ROW */
        .header-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 15px 20px 5px 20px;
            background-color: var(--header-bg);
            direction: ltr; 
            height: 85px; 
        }

        .header-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .align-start { align-items: flex-start; text-align: left; }
        .align-end { align-items: flex-end; text-align: right; }
        .align-center { align-items: center; text-align: center; }

        .label-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 14px; 
        }
        .main-text {
            font-size: 1.1rem;
            font-weight: bold;
            line-height: 1.2;
        }

        .mosque-icon {
            font-size: 2.5rem;
            opacity: 0.9;
            margin: 0 10px;
        }

        /* DATE ROW */
        .date-row {
            text-align: center;
            padding: 0 10px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-card);
            height: 60px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            white-space: pre-line;
        }
        
        /* Specific Hijri styling for Arabic */
        [lang="ar"] .hijri-main {
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
            direction: rtl;
            display: inline-block;
        }
        
        [lang="ar"] .greg-sub {
            font-size: 0.75rem;
            opacity: 0.8;
            direction: rtl;
        }

        /* PRAYER BAR */
        .prayer-bar {
            display: flex;
            overflow-x: auto;
            background-color: rgba(0,0,0,0.1);
            scrollbar-width: none;
            direction: ltr;
            height: 70px; 
        }
        .prayer-bar::-webkit-scrollbar { display: none; }

        .prayer-item {
            flex: 1;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 1px solid var(--border-card);
        }
        .prayer-item:last-child { border-right: none; }
        
        .prayer-item.active {
            background-color: var(--highlight-bg);
            font-weight: bold;
        }
        .p-name { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .p-time { font-size: 1rem; font-weight: bold; direction: ltr; }

        /* CONTROLS SECTION */
        .controls-row {
            padding: 10px 20px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            border-top: 1px solid var(--border-card);
            direction: ltr;
            flex-grow: 1; 
            justify-content: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .input-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 3px; 
            text-align: center;
            height: 12px;
        }

        .inputs-row {
            display: flex;
            gap: 15px;
            width: 100%;
        }

        .input-box {
            background: var(--input-bg);
            border: 1px solid var(--border-card);
            color: var(--text-primary);
            padding: 6px; 
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            outline: none;
            text-align: center;
            width: 100%;
            height: 34px; 
        }
        .input-box option { background: #333; color: #fff; }

        /* BUTTONS */
        .tools {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 25px;
            position: relative;
            height: 35px; 
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.4rem;
            color: var(--text-secondary);
            transition: 0.2s;
            padding: 0;
            line-height: 1;
        }
        .icon-btn:hover { color: var(--text-primary); transform: scale(1.1); }

        .lang-btn {
            background: var(--input-bg);
            border: 1px solid var(--border-card);
            color: var(--text-primary);
            padding: 0;
            width: 50px;
            height: 28px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* COLOR POPUP */
        .color-popup {
            display: none;
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(30px);
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 8px;
            z-index: 100;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            width: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.2s;
        }
        .color-dot:hover { transform: scale(1.2); border-color: #fff; }

        /* Audio hint toast */
        #audio-hint {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

    </style>
</head>
<body>

    <audio id="adhan-audio" src="https://media.blubrry.com/muslim_central_quran/podcasts.qurancentral.com/adhan/makkah.mp3" preload="auto"></audio>
    <div id="audio-hint">Sound enabled</div>

    <div class="widget-card">
        
        <!-- HEADER -->
        <div class="header-row">
            <div class="header-item align-start">
                <span class="label-text" id="lbl-next">Next Prayer</span>
                <span class="main-text" id="countdown">--:--:--</span>
            </div>
            <div class="header-item align-center">
                <div class="mosque-icon">ðŸ•Œ</div>
            </div>
            <div class="header-item align-end">
                <span class="label-text" id="city-display">...</span>
                <span class="main-text" id="clock">00:00</span>
            </div>
        </div>

        <!-- DATE -->
        <div class="date-row">
            <div class="date-text" id="date-display">Loading...</div>
        </div>

        <!-- PRAYER SCROLL -->
        <div class="prayer-bar" id="prayers-container"></div>

        <!-- CONTROLS -->
        <div class="controls-row">
            
            <div class="inputs-row">
                <div class="input-group">
                    <span class="input-label" id="lbl-city">Choose City</span>
                    <input type="text" id="input-city" class="input-box" value="Ain Oussera" onchange="updateLoc()">
                </div>
                <div class="input-group">
                    <span class="input-label" id="lbl-country">Choose Country</span>
                    <select id="input-country" class="input-box" onchange="updateLoc()">
                        <option value="Algeria">Algeria</option>
                        <option value="Saudi Arabia">Saudi Arabia</option>
                        <option value="Egypt">Egypt</option>
                        <option value="Morocco">Morocco</option>
                        <option value="Tunisia">Tunisia</option>
                        <option value="France">France</option>
                        <option value="US">USA</option>
                        <option value="UK">UK</option>
                        <option value="Turkey">Turkey</option>
                        <option value="Indonesia">Indonesia</option>
                        <option value="Malaysia">Malaysia</option>
                    </select>
                </div>
            </div>

            <div class="tools">
                <!-- Sound Left -->
                <button class="icon-btn" onclick="toggleSound()" id="btn-sound">ðŸ”Š</button>
                
                <!-- Language Center -->
                <button class="lang-btn" onclick="toggleLang()" id="btn-lang">EN</button>
                
                <!-- Color Right -->
                <button class="icon-btn" onclick="toggleColors()">ðŸŽ¨</button>

                <!-- Color Popup -->
                <div class="color-popup" id="color-menu">
                    <div class="color-dot" style="background:#581c33" onclick="setTheme('pink')"></div>
                    <div class="color-dot" style="background:#2e1a47" onclick="setTheme('purple')"></div>
                    <div class="color-dot" style="background:#3d0e0e" onclick="setTheme('red')"></div>
                    <div class="color-dot" style="background:#42210b" onclick="setTheme('orange')"></div>
                    <div class="color-dot" style="background:#85751f" onclick="setTheme('yellow')"></div>
                    <div class="color-dot" style="background:#13381e" onclick="setTheme('green')"></div>
                    <div class="color-dot" style="background:#0e333d" onclick="setTheme('cyan')"></div>
                    <div class="color-dot" style="background:#111e3d" onclick="setTheme('blue')"></div>
                    <div class="color-dot" style="background:#3d2b1e" onclick="setTheme('brown')"></div>
                    <div class="color-dot" style="background:#595959" onclick="setTheme('grey')"></div>
                    <div class="color-dot" style="background:#000" onclick="setTheme('black')"></div>
                    <div class="color-dot" style="background:#fff" onclick="setTheme('white')"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        const state = {
            lang: localStorage.getItem('p_lang') || 'en',
            theme: localStorage.getItem('p_theme') || 'pink',
            sound: true,
            city: "Ain Oussera",
            country: "Algeria",
            timings: null,
            hijri: null,
            audioReady: false,
            lastPlayedPrayer: ""
        };

        const TEXT = {
            en: {
                fajr: "Fajr", sunrise: "Sunrise", dhuhr: "Dhuhr", asr: "Asr", maghrib: "Maghrib", isha: "Isha",
                next: "Next Prayer", loading: "Loading...", btn: "Ø¹Ø±Ø¨ÙŠ",
                selCity: "Choose City", selCountry: "Choose Country"
            },
            ar: {
                fajr: "Ø§Ù„ÙØ¬Ø±", sunrise: "Ø§Ù„Ø´Ø±ÙˆÙ‚", dhuhr: "Ø§Ù„Ø¸Ù‡Ø±", asr: "Ø§Ù„Ø¹ØµØ±", maghrib: "Ø§Ù„Ù…ØºØ±Ø¨", isha: "Ø§Ù„Ø¹Ø´Ø§Ø¡",
                next: "Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", loading: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", btn: "EN",
                selCity: "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", selCountry: "Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©"
            }
        };

        const audio = document.getElementById('adhan-audio');

        // --- INIT ---
        window.onload = () => {
            // Fix: Browser Policy requires interaction
            document.addEventListener('click', enableAudio, { once: true });
            document.addEventListener('touchstart', enableAudio, { once: true });

            applyTheme(state.theme);
            applyLang(state.lang);
            
            const params = new URLSearchParams(window.location.search);
            if(params.get('city')) state.city = params.get('city');
            if(params.get('country')) state.country = params.get('country');
            if(params.get('theme')) applyTheme(params.get('theme'));

            document.getElementById('input-city').value = state.city;
            document.getElementById('input-country').value = state.country;

            fetchData();
            setInterval(tick, 1000);
        };

        function enableAudio() {
            if(state.sound) {
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    state.audioReady = true;
                    // Flash hint
                    const hint = document.getElementById('audio-hint');
                    hint.style.opacity = '1';
                    setTimeout(() => hint.style.opacity = '0', 2000);
                }).catch(err => console.log("Audio init error:", err));
            }
        }

        // --- LOGIC ---
        async function fetchData() {
            try {
                const url = `https://api.aladhan.com/v1/timingsByCity?city=${state.city}&country=${state.country}&method=19`;
                const res = await fetch(url);
                const data = await res.json();
                
                state.timings = data.data.timings;
                state.hijri = data.data.date.hijri;
                
                renderUI();
            } catch (e) { console.error(e); }
        }

        function tick() {
            const now = new Date();
            const timeOpts = { hour: '2-digit', minute:'2-digit', hour12: false };
            const clockEl = document.getElementById('clock');
            clockEl.innerText = now.toLocaleTimeString('en-GB', timeOpts);

            if(state.timings) updateCountdown(now);
        }

        function updateCountdown(now) {
            const prayers = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            const curMins = now.getHours() * 60 + now.getMinutes();
            const curSecs = now.getSeconds();

            let nextP = null;
            let nextName = "";

            for(let i=0; i<prayers.length; i++) {
                const [h, m] = state.timings[prayers[i]].split(':').map(Number);
                const pMins = h * 60 + m;
                if(pMins > curMins) {
                    nextP = pMins;
                    nextName = prayers[i];
                    break;
                }
            }

            if(!nextP) {
                const [h, m] = state.timings['Fajr'].split(':').map(Number);
                nextP = (h * 60 + m) + (24 * 60);
                nextName = 'Fajr';
            }

            // UI Update
            document.querySelectorAll('.prayer-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`p-${nextName}`);
            if(activeEl) activeEl.classList.add('active');

            const diffMins = nextP - curMins - 1;
            const diffSecs = 60 - curSecs;
            const hLeft = Math.floor(diffMins / 60);
            const mLeft = diffMins % 60;

            const str = `-${hLeft}:${mLeft<10?'0'+mLeft:mLeft}:${diffSecs<10?'0'+diffSecs:diffSecs}`;
            document.getElementById('countdown').innerText = str;
            
            const dict = TEXT[state.lang];
            const pNameTrans = dict[nextName.toLowerCase()];
            document.getElementById('lbl-next').innerText = `${dict.next}: ${pNameTrans}`;

            // --- AUDIO LOGIC FIX ---
            // If timer is at 00:00:00 (or close to it due to lag)
            if(state.sound && hLeft === 0 && mLeft === 0 && diffSecs <= 2) {
                if(state.lastPlayedPrayer !== nextName && nextName !== 'Sunrise') {
                    // Try to play
                    if(state.audioReady) {
                        audio.currentTime = 0;
                        audio.play().catch(e => console.error("Play failed:", e));
                    }
                    state.lastPlayedPrayer = nextName;
                }
            } else if (diffMins > 1) {
                // Reset tracker if we are far away from prayer
                state.lastPlayedPrayer = "";
            }
        }

        function formatDate() {
            if(!state.timings || !state.hijri) return;
            const h = state.hijri;
            const el = document.getElementById('date-display');
            const now = new Date();
            
            if (state.lang === 'en') {
                const suffix = getOrdinal(h.day);
                const hijriStr = `${h.day}${suffix} ${h.month.en}, ${h.year} AH`;
                const gregStr = now.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
                el.innerHTML = `<span style="opacity:0.8">${hijriStr}</span><br><span style="font-weight:bold">${gregStr}</span>`;
            } else {
                // FIXED: Hijri Date in Arabic on one line, bold, matching image
                const hijriStr = `${h.day} ${h.month.ar} ${h.year} Ù‡Ù€`;
                let gregStr = now.toLocaleDateString('ar-DZ', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                gregStr += " Ù…"; 
                // Using span with direction: rtl
                el.innerHTML = `<span class="hijri-main">${hijriStr}</span><br><span class="greg-sub">${gregStr}</span>`;
            }
        }

        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        function renderUI() {
            const container = document.getElementById('prayers-container');
            container.innerHTML = '';
            const dict = TEXT[state.lang];
            const list = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

            list.forEach(k => {
                const time = state.timings[k].split(' ')[0];
                const div = document.createElement('div');
                div.className = 'prayer-item';
                div.id = `p-${k}`;
                div.innerHTML = `<span class="p-name">${dict[k.toLowerCase()]}</span><span class="p-time">${time}</span>`;
                container.appendChild(div);
            });

            document.getElementById('city-display').innerText = state.city;
            document.getElementById('lbl-city').innerText = dict.selCity;
            document.getElementById('lbl-country').innerText = dict.selCountry;
            formatDate();
        }

        function toggleLang() {
            applyLang(state.lang === 'en' ? 'ar' : 'en');
            renderUI();
        }

        function applyLang(l) {
            state.lang = l;
            localStorage.setItem('p_lang', l);
            document.documentElement.lang = l;
            document.getElementById('btn-lang').innerText = TEXT[l].btn;
            if(l === 'ar') {
                document.getElementById('input-city').placeholder = "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©";
            } else {
                document.getElementById('input-city').placeholder = "City";
            }
        }

        function toggleSound() {
            state.sound = !state.sound;
            const btn = document.getElementById('btn-sound');
            btn.innerText = state.sound ? "ðŸ”Š" : "ðŸ”‡";
            btn.style.opacity = state.sound ? "1" : "0.5";
            // Re-prime if turning on
            if(state.sound && !state.audioReady) enableAudio();
        }

        function toggleColors() {
            const m = document.getElementById('color-menu');
            m.style.display = m.style.display === 'grid' ? 'none' : 'grid';
        }

        function applyTheme(t) {
            state.theme = t;
            localStorage.setItem('p_theme', t);
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('color-menu').style.display = 'none';
        }
        function setTheme(t) { applyTheme(t); }

        function updateLoc() {
            state.city = document.getElementById('input-city').value;
            state.country = document.getElementById('input-country').value;
            document.getElementById('date-display').innerText = TEXT[state.lang].loading;
            fetchData();
        }
    </script>
</body>
</html>
